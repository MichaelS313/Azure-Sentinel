{
    "id": "SAPETDAlerts",
    "title": "SAP Enterprise Threat Detection, cloud edition",
    "publisher": "SAP",
    "descriptionMarkdown": "[API to retrieve Alerts from SAP Enterprie Threat Detection, cloud edition](https://api.sap.com/package/SAPEnterpriseThreatDetectionCloud/odatav4)",
    "graphQueries": [
        {
            "metricName": "Total data received",
            "legend": "ETDAlerts_CL",
            "baseQuery": "ETDAlerts_CL"
        }
    ],
    "sampleQueries": [
        {
            "description": "List of events by severity",
            "query": "ETDAlerts_CL\n            | where Message has \"TokenIssuedEvent\"\n            | extend MessageDetail = tostring(parse_json(tostring(Message.data)).message)\n            | project UpdatedOn, UserName, IPAddress = tostring(Message.ip), MessageDetail"
        }
    ],
    "dataTypes": [
        {
            "name": "ETDAlerts_CL",
            "lastDataReceivedQuery": "ETDAlerts_CL\n            | summarize Time = max(CreationTimestamp)\n            | where isnotempty(Time)"
        }
    ],
    "connectivityCriterias": [
        {
            "type": "IsConnectedQuery",
            "value": [
                "ETDAlerts_CL\n            | summarize LastLogReceived = max(CreationTimestamp)\n            | project IsConnected = LastLogReceived > ago(30d)"
            ]
        }
    ],
    "availability": {
        "status": 1,
        "isPreview": true
    },
    "permissions": {
        "resourceProvider": [
            {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions on the workspace are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                    "write": true,
                    "read": true,
                    "delete": true
                }
            },
			{
				"provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
				"permissionsDisplayText": "read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key).",
				"providerDisplayName": "Keys",
				"scope": "Workspace",
				"requiredPermissions": {
					"action": true
				}
			}
        ],
        "customs": [
            {
                "name": "Microsoft.Web/sites permissions",
                "description": "Read and write permissions to Azure Functions to create a Function App is required. [See the documentation to learn more about Azure Functions](https://docs.microsoft.com/azure/azure-functions/)."
            },
            {
                "name": "Microsoft.Insights/DataCollectionEndpoints, Microsoft.Insights/DataCollectionRules",
                "description": "Read and write permissions to Data Collection Rules/Endpoints is required. Permissions to assign the Monitoring Metrics Publisher role to the Azure Function is required. [See the documentation to learn more about Data Collection Rules](https://docs.microsoft.com/azure/azure-monitor/platform/data-collection-rules)."
            },
            {
                "name": "Azure Key Vault",
                "description": "A Key Vault to hold SAP ETD client secret [See the documentation to learn more about Key Vault](https://docs.microsoft.com/azure/key-vault/general/overview)."
            },
            {
                "name": "SAP Enterprise Threat Detection service key",
                "description": "Connectivity and permissions to retrieve SAP ETD alerts via the API."
            }
        ]
    },
    "instructionSteps": [
        {
            "title": "",
            "description": ">**NOTE:** This connector uses Azure Functions to connect to SAP ETD alerts into Microsoft Sentinel. This might result in additional data ingestion costs. Check the [Azure Functions pricing page](https://azure.microsoft.com/pricing/details/functions/) for details."
        },
        {
            "title": "",
            "description": "**Step 1 - Create a an Azure Key Vault**\n\n Refer to the [Azure Key Vault quickstart guide](https://learn.microsoft.com/azure/key-vault/general/quick-create-portal) for details. This key vault will hold a client secret required to access the ETD API."
        },
        {
            "title": "",
            "description": "**Step 2 - Configuration steps for the SAP ETD API**\n\nFollow the steps provided by SAP [see obtain client credentials for SAP ETD](https://help.sap.com/docs/SAP_ENTERPRISE_THREAT_DETECTION_CLOUD_EDITION/61b4ae57d25948a5a9e5d6751d3efbda/81996287df9f4037b315dc331676f555.html). \n\n1. The resulting service key contains in the uaa section the sburl for getting the OAuth token. \n\n2. The url call looks like url/oauth/token?grant_type=client_credentials. The Authentication is of type 'Basic' with the Base64 encoded ClientID and clientsecret from the uaa section of the servicekey. \n\n2. The received token is then to be used for calling the data retrieval service url, shown at the begin of the service key. The url GET call looks like url//alerts/v1/Alerts plus query parameters."

        },
        {
            "title": "",
            "description": "**Step 3 - Azure Resource Manager (ARM) Template**\n\n1. Click the **Deploy to Azure** button below. \n\n\t[![Deploy To Azure](https://aka.ms/deploytoazurebutton)](https://aka.ms/sentinel-sapetd-azuredeploy)\n2. Enter the values collected in steps 1 and 2 as parameters in the ARM template. Populate Key Vault name, name of the Key Vault secret, Audit Retrieval API URL, UAA Server URL, clientid.\n3. Click **Purchase** to deploy."
        }
    ]
}
